var Q=(F,_,y)=>new Promise((A,f)=>{var E=c=>{try{p(y.next(c))}catch(v){f(v)}},a=c=>{try{p(y.throw(c))}catch(v){f(v)}},p=c=>c.done?A(c.value):Promise.resolve(c.value).then(E,a);p((y=y.apply(F,_)).next())});import{c as ue,d as oe,Z as W,l as D,a0 as G,am as ie,cL as U,L as ae,r as o,o as C,e as $,u as l,E as S,w as e,g as t,h as n,q as r,F as J,al as X,z as de,A as _e,an as fe,aE as pe,aD as me,aG as ve,aW as Fe,Q as Z,s as K,t as z,R as Y,b7 as Ee,a3 as ge}from"./index-ceb04263.js";import{d as ee}from"./chartEditStore-66e39698.js";import{i as L}from"./icon-e92a95d4.js";import{T as M,D as N}from"./index-27fb9bd9.js";import{u as ne}from"./useTargetData.hook-5fa14525.js";import{M as he}from"./EditorWorker-a2a07979.js";import"./editorWorker-43a98755.js";import{g as Ce}from"./plugin-6413e978.js";import{c as ye}from"./http-d36ff187.js";import{F as te}from"./fileTypeEnum-21359a08.js";import{r as we,d as De}from"./file-84751f49.js";const P=F=>(de("data-v-342e81fa"),F=F(),_e(),F),Be=P(()=>r("p",null,[r("span",{class:"func-keyword"},"function"),n("  filter(data, res)  {")],-1)),xe={class:"go-ml-4"},be=P(()=>r("p",null,"}",-1)),Ae=P(()=>r("span",{class:"func-keyword"},"function",-1)),Se={class:"editor-data-show"},ke={class:"editor-data-show"},Te={class:"editor-data-show"},Re={class:"go-flex-items-center"},qe=oe({__name:"index",setup(F){const{DocumentTextIcon:_}=L.ionicons5,{FilterIcon:y,FilterEditIcon:A}=L.carbon,{targetData:f,chartEditStore:E}=ne();W(f.value.request),W(E.getRequestGlobalConfig);const a=D(!1),p=D(f.value.filter||"return data"),c=D(!1),v=D(""),k=()=>Q(this,null,function*(){try{const m=yield ye(X(f.value.request),X(E.getRequestGlobalConfig));if(m){v.value=m;return}window.$message.warning("没有拿到返回值，请检查接口！")}catch(m){console.error(m),window.$message.warning("数据异常，请检查参数！")}}),O=G(()=>{try{const m=new Function("data","res",p.value),g=ie(v.value),u=m(g==null?void 0:g.data,g);return c.value=!1,U(u)}catch(m){return c.value=!0,`过滤函数错误，日志：${m}`}}),R=()=>{a.value=!0},V=()=>{Ce({message:"是否删除过滤器",onPositiveCallback:()=>{f.value.filter=void 0}})},q=()=>{a.value=!1},I=()=>{if(c.value){window.$message.error("过滤函数错误，无法进行保存");return}f.value.filter=p.value,q()};return ae(()=>a.value,m=>{m&&(k(),p.value=f.value.filter||"return data")}),(m,g)=>{const u=o("n-code"),s=o("n-icon"),d=o("n-button"),i=o("n-space"),w=o("n-card"),x=o("n-text"),b=o("n-tag"),T=o("n-divider"),j=o("n-scrollbar"),H=o("n-modal");return C(),$(J,null,[l(f).filter?(C(),S(w,{key:0},{footer:e(()=>[t(i,{justify:"end"},{default:e(()=>[t(d,{type:"primary",tertiary:"",size:"small",onClick:R},{icon:e(()=>[t(s,null,{default:e(()=>[t(l(A))]),_:1})]),default:e(()=>[n(" 编辑 ")]),_:1}),t(d,{tertiary:"",size:"small",onClick:V},{default:e(()=>[n(" 删除 ")]),_:1})]),_:1})]),default:e(()=>[Be,r("div",xe,[t(u,{code:l(f).filter,language:"typescript"},null,8,["code"])]),be]),_:1})):(C(),S(d,{key:1,class:"go-ml-3",onClick:R},{icon:e(()=>[t(s,null,{default:e(()=>[t(l(y))]),_:1})]),default:e(()=>[n(" 新增过滤器 ")]),_:1})),t(H,{class:"go-chart-data-monaco-editor",show:a.value,"onUpdate:show":g[1]||(g[1]=B=>a.value=B),"mask-closable":!1,closeOnEsc:!1},{default:e(()=>[t(w,{bordered:!1,role:"dialog",size:"small","aria-modal":"true",style:{width:"1000px",height:"600px"}},{header:e(()=>[t(i,null,{default:e(()=>[t(x,null,{default:e(()=>[n("过滤器函数编辑器")]),_:1})]),_:1})]),"header-extra":e(()=>[]),action:e(()=>[t(i,{justify:"space-between"},{default:e(()=>[r("div",Re,[t(b,{bordered:!1,type:"primary"},{icon:e(()=>[t(s,{component:l(_)},null,8,["component"])]),default:e(()=>[n(" 规则 ")]),_:1}),t(x,{class:"go-ml-2",depth:"2"},{default:e(()=>[n("过滤器默认处理接口返回值的「data」字段")]),_:1})]),t(i,null,{default:e(()=>[t(d,{size:"medium",onClick:q},{default:e(()=>[n("取消")]),_:1}),t(d,{size:"medium",type:"primary",onClick:I},{default:e(()=>[n("保存")]),_:1})]),_:1})]),_:1})]),default:e(()=>[t(i,{size:"small",vertical:""},{default:e(()=>[t(i,{justify:"space-between"},{default:e(()=>[r("div",null,[t(i,{vertical:""},{default:e(()=>[t(b,{type:"info"},{default:e(()=>[Ae,n("  filter(data, res)  { ")]),_:1}),t(l(he),{modelValue:p.value,"onUpdate:modelValue":g[0]||(g[0]=B=>p.value=B),width:"460px",height:"380px",language:"javascript"},null,8,["modelValue"]),t(b,{type:"info"},{default:e(()=>[n("}")]),_:1})]),_:1})]),t(T,{vertical:"",style:{height:"480px"}}),t(j,{style:{"max-height":"480px"}},{default:e(()=>[t(i,{size:15,vertical:""},{default:e(()=>[r("div",Se,[t(i,null,{default:e(()=>{var B;return[t(x,{depth:"3"},{default:e(()=>[n("默认过滤数据(data)：")]),_:1}),t(u,{code:l(U)((B=v.value)==null?void 0:B.data)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]}),_:1})]),r("div",ke,[t(i,null,{default:e(()=>[t(x,{depth:"3"},{default:e(()=>[n("接口返回数据(res)：")]),_:1}),t(u,{code:l(U)(v.value)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),r("div",Te,[t(i,null,{default:e(()=>[t(x,{depth:"3"},{default:e(()=>[n("过滤器结果：")]),_:1}),t(u,{code:O.value||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])],64)}}}),Ie=ue(qe,[["__scopeId","data-v-342e81fa"]]),je=F=>{const _=D();return{uploadFileListRef:_,beforeUpload:({file:E})=>{_.value=[];const a=E.file.type;return a!==te.JSON&&a!==te.TXT?(window.$message.warning("仅支持上传 【JSON】 格式文件，请重新上传！"),!1):!0},customRequest:E=>{const{file:a}=E;fe(()=>{a.file?we(a.file).then(p=>{F.value.option.dataset=pe(p)}):window.$message.error("导入数据失败，请稍后重试或联系管理员！")})},download:()=>{try{window.$message.success("下载中，请耐心等待..."),De(me(F.value.option.dataset),void 0,"json")}catch(E){window.$message.error("下载失败，数据错误！")}}}};const ze=oe({__name:"index",props:{show:{type:Boolean,required:!1},ajax:{type:Boolean,required:!0}},setup(F){const{targetData:_}=ne(),y=["字段","映射","状态"],{HelpOutlineIcon:A}=L.ionicons5,{DocumentAddIcon:f,DocumentDownloadIcon:E}=L.carbon,a=D(),p=D(),c=D(),v=D(!1),{uploadFileListRef:k,customRequest:O,beforeUpload:R,download:V}=je(_),q=G(()=>_.value.request.requestDataType!==ve.STATIC),I=G(()=>_.value.chartConfig.chartFrame===ee.ECHARTS),m=u=>{let s=N.SUCCESS;for(let d=0;d<a.value.length;d++)if(a.value[d][u]===void 0)return s=N.FAILURE,s;return N.SUCCESS},g=()=>{try{return p.value.map((u,s)=>s===0?{field:"通用标识",mapping:u,result:N.NULL}:{field:`数据项-${s}`,mapping:u,result:m(u)})}catch(u){return[]}};return ae(()=>{var u,s;return(s=(u=_.value)==null?void 0:u.option)==null?void 0:s.dataset},u=>{var s,d;u&&((d=(s=_==null?void 0:_.value)==null?void 0:s.chartConfig)==null?void 0:d.chartFrame)===ee.ECHARTS?(a.value=u,I.value&&(p.value=u.dimensions,c.value=g())):u!=null?(c.value=null,a.value=u):(v.value=!0,a.value="此组件无数据源"),Fe(u)&&(c.value=null)},{immediate:!0}),(u,s)=>{const d=o("n-badge"),i=o("n-text"),w=o("n-space"),x=o("n-table"),b=o("n-timeline-item"),T=o("n-icon"),j=o("n-button"),H=o("n-upload"),B=o("n-tooltip"),le=o("n-code"),se=o("n-card"),re=o("n-timeline");return C(),S(re,{class:"go-chart-configurations-timeline"},{default:e(()=>[Z(t(b,{type:"info",title:l(M).MAPPING},{default:e(()=>[t(x,{striped:""},{default:e(()=>[r("thead",null,[r("tr",null,[(C(),$(J,null,K(y,h=>r("th",{key:h},z(h),1)),64))])]),r("tbody",null,[(C(!0),$(J,null,K(c.value,(h,ce)=>(C(),$("tr",{key:ce},[r("td",null,z(h.field),1),r("td",null,z(h.mapping),1),r("td",null,[h.result===0?(C(),S(w,{key:0},{default:e(()=>[t(d,{dot:"",type:"success"}),t(i,null,{default:e(()=>[n("无")]),_:1})]),_:1})):(C(),S(w,{key:1},{default:e(()=>[t(d,{dot:"",type:h.result===1?"success":"error"},null,8,["type"]),t(i,null,{default:e(()=>[n("匹配"+z(h.result===1?"成功":"失败"),1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})]),_:1},8,["title"]),[[Y,I.value&&c.value]]),Z(t(b,{color:"#97846c",title:l(M).FILTER},{default:e(()=>[t(w,{size:18,vertical:""},{default:e(()=>[t(i,{depth:"3"},{default:e(()=>[n("过滤器默认处理接口返回值的「data」字段")]),_:1}),t(l(Ie))]),_:1})]),_:1},8,["title"]),[[Y,q.value]]),t(b,{type:"success",title:l(M).CONTENT},{default:e(()=>[t(w,{vertical:""},{default:e(()=>[t(w,{class:"source-btn-box"},{default:e(()=>[t(H,{"file-list":l(k),"onUpdate:fileList":s[0]||(s[0]=h=>Ee(k)?k.value=h:null),"show-file-list":!1,customRequest:l(O),onBeforeUpload:l(R)},{default:e(()=>[t(w,null,{default:e(()=>[F.ajax?ge("",!0):(C(),S(j,{key:0,class:"sourceBtn-item",disabled:v.value},{icon:e(()=>[t(T,null,{default:e(()=>[t(l(f))]),_:1})]),default:e(()=>[n(" 导入（json / txt） ")]),_:1},8,["disabled"]))]),_:1})]),_:1},8,["file-list","customRequest","onBeforeUpload"]),r("div",null,[t(j,{class:"sourceBtn-item",disabled:v.value,onClick:l(V)},{icon:e(()=>[t(T,null,{default:e(()=>[t(l(E))]),_:1})]),default:e(()=>[n(" 下载 ")]),_:1},8,["disabled","onClick"]),t(B,{trigger:"hover"},{trigger:e(()=>[t(T,{class:"go-ml-1",size:"21",depth:3},{default:e(()=>[t(l(A))]),_:1})]),default:e(()=>[t(i,{depth:"3"},{default:e(()=>[n("点击【下载】查看完整数据")]),_:1})]),_:1})])]),_:1}),t(se,{size:"small"},{default:e(()=>[t(le,{code:l(U)(a.value),language:"json"},null,8,["code"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})}}}),We=ue(ze,[["__scopeId","data-v-72544ebc"]]);export{We as C};
