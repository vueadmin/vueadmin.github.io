var Q=(h,_,y)=>new Promise((A,f)=>{var v=r=>{try{p(y.next(r))}catch(F){f(F)}},a=r=>{try{p(y.throw(r))}catch(F){f(F)}},p=r=>r.done?A(r.value):Promise.resolve(r.value).then(v,a);p((y=y.apply(h,_)).next())});import{c as ue,d as oe,Z as X,l as B,a0 as J,ak as ie,cJ as z,L as ne,r as n,o as C,e as N,u as o,B as S,w as e,g as t,q as c,F as P,h as l,aj as Z,z as de,A as _e,al as fe,aC as pe,aB as me,aE as Fe,aU as he,Q as K,R as W,s as Y,t as I,b5 as ve,a3 as Ee}from"./index-564e271e.js";import{d as ee}from"./chartEditStore-a19f0a3f.js";import{i as L}from"./icon-472382c6.js";import{T as M,D as U}from"./index-fef903bc.js";import{u as ae}from"./useTargetData.hook-6d85837e.js";import{M as ge}from"./EditorWorker-712a8a0b.js";import"./editorWorker-09f50f3f.js";import{g as Ce}from"./plugin-8276e592.js";import{c as ye}from"./http-c74b9c92.js";import{F as te}from"./fileTypeEnum-21359a08.js";import{r as we,d as Be}from"./file-84751f49.js";const G=h=>(de("data-v-342e81fa"),h=h(),_e(),h),De=G(()=>c("p",null,[c("span",{class:"func-keyword"},"function"),l("  filter(data, res)  {")],-1)),xe={class:"go-ml-4"},be=G(()=>c("p",null,"}",-1)),Ae=l(" 编辑 "),Se=l(" 删除 "),ke=l(" 新增过滤器 "),Te=l("过滤器函数编辑器"),Re=G(()=>c("span",{class:"func-keyword"},"function",-1)),$e=l("  filter(data, res)  { "),qe=l("}"),je={class:"editor-data-show"},Ie=l("默认过滤数据(data)："),Ue={class:"editor-data-show"},ze=l("接口返回数据(res)："),Ne={class:"editor-data-show"},Le=l("过滤器结果："),Oe={class:"go-flex-items-center"},Ve=l(" 规则 "),He=l("过滤器默认处理接口返回值的「data」字段"),Me=l("取消"),Je=l("保存"),Pe=oe({__name:"index",setup(h){const{DocumentTextIcon:_}=L.ionicons5,{FilterIcon:y,FilterEditIcon:A}=L.carbon,{targetData:f,chartEditStore:v}=ae();X(f.value.request),X(v.getRequestGlobalConfig);const a=B(!1),p=B(f.value.filter||"return data"),r=B(!1),F=B(""),k=()=>Q(this,null,function*(){try{const m=yield ye(Z(f.value.request),Z(v.getRequestGlobalConfig));if(m){F.value=m;return}window.$message.warning("没有拿到返回值，请检查接口！")}catch(m){console.error(m),window.$message.warning("数据异常，请检查参数！")}}),O=J(()=>{try{const m=new Function("data","res",p.value),E=ie(F.value),u=m(E==null?void 0:E.data,E);return r.value=!1,z(u)}catch(m){return r.value=!0,`过滤函数错误，日志：${m}`}}),R=()=>{a.value=!0},V=()=>{Ce({message:"是否删除过滤器",onPositiveCallback:()=>{f.value.filter=void 0}})},$=()=>{a.value=!1},q=()=>{if(r.value){window.$message.error("过滤函数错误，无法进行保存");return}f.value.filter=p.value,$()};return ne(()=>a.value,m=>{m&&(k(),p.value=f.value.filter||"return data")}),(m,E)=>{const u=n("n-code"),s=n("n-icon"),d=n("n-button"),i=n("n-space"),w=n("n-card"),x=n("n-text"),b=n("n-tag"),T=n("n-divider"),j=n("n-scrollbar"),H=n("n-modal");return C(),N(P,null,[o(f).filter?(C(),S(w,{key:0},{footer:e(()=>[t(i,{justify:"end"},{default:e(()=>[t(d,{type:"primary",tertiary:"",size:"small",onClick:R},{icon:e(()=>[t(s,null,{default:e(()=>[t(o(A))]),_:1})]),default:e(()=>[Ae]),_:1}),t(d,{tertiary:"",size:"small",onClick:V},{default:e(()=>[Se]),_:1})]),_:1})]),default:e(()=>[De,c("div",xe,[t(u,{code:o(f).filter,language:"typescript"},null,8,["code"])]),be]),_:1})):(C(),S(d,{key:1,class:"go-ml-3",onClick:R},{icon:e(()=>[t(s,null,{default:e(()=>[t(o(y))]),_:1})]),default:e(()=>[ke]),_:1})),t(H,{class:"go-chart-data-monaco-editor",show:a.value,"onUpdate:show":E[1]||(E[1]=D=>a.value=D),"mask-closable":!1,closeOnEsc:!1},{default:e(()=>[t(w,{bordered:!1,role:"dialog",size:"small","aria-modal":"true",style:{width:"1000px",height:"600px"}},{header:e(()=>[t(i,null,{default:e(()=>[t(x,null,{default:e(()=>[Te]),_:1})]),_:1})]),"header-extra":e(()=>[]),action:e(()=>[t(i,{justify:"space-between"},{default:e(()=>[c("div",Oe,[t(b,{bordered:!1,type:"primary"},{icon:e(()=>[t(s,{component:o(_)},null,8,["component"])]),default:e(()=>[Ve]),_:1}),t(x,{class:"go-ml-2",depth:"2"},{default:e(()=>[He]),_:1})]),t(i,null,{default:e(()=>[t(d,{size:"medium",onClick:$},{default:e(()=>[Me]),_:1}),t(d,{size:"medium",type:"primary",onClick:q},{default:e(()=>[Je]),_:1})]),_:1})]),_:1})]),default:e(()=>[t(i,{size:"small",vertical:""},{default:e(()=>[t(i,{justify:"space-between"},{default:e(()=>[c("div",null,[t(i,{vertical:""},{default:e(()=>[t(b,{type:"info"},{default:e(()=>[Re,$e]),_:1}),t(o(ge),{modelValue:p.value,"onUpdate:modelValue":E[0]||(E[0]=D=>p.value=D),width:"460px",height:"380px",language:"javascript"},null,8,["modelValue"]),t(b,{type:"info"},{default:e(()=>[qe]),_:1})]),_:1})]),t(T,{vertical:"",style:{height:"480px"}}),t(j,{style:{"max-height":"480px"}},{default:e(()=>[t(i,{size:15,vertical:""},{default:e(()=>[c("div",je,[t(i,null,{default:e(()=>{var D;return[t(x,{depth:"3"},{default:e(()=>[Ie]),_:1}),t(u,{code:o(z)((D=F.value)==null?void 0:D.data)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]}),_:1})]),c("div",Ue,[t(i,null,{default:e(()=>[t(x,{depth:"3"},{default:e(()=>[ze]),_:1}),t(u,{code:o(z)(F.value)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),c("div",Ne,[t(i,null,{default:e(()=>[t(x,{depth:"3"},{default:e(()=>[Le]),_:1}),t(u,{code:o(O)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])],64)}}}),Ge=ue(Pe,[["__scopeId","data-v-342e81fa"]]),Qe=h=>{const _=B();return{uploadFileListRef:_,beforeUpload:({file:v})=>{_.value=[];const a=v.file.type;return a!==te.JSON&&a!==te.TXT?(window.$message.warning("仅支持上传 【JSON】 格式文件，请重新上传！"),!1):!0},customRequest:v=>{const{file:a}=v;fe(()=>{a.file?we(a.file).then(p=>{h.value.option.dataset=pe(p)}):window.$message.error("导入数据失败，请稍后重试或联系管理员！")})},download:()=>{try{window.$message.success("下载中，请耐心等待..."),Be(me(h.value.option.dataset),void 0,"json")}catch(v){window.$message.error("下载失败，数据错误！")}}}};const Xe=l("无"),Ze=l("过滤器默认处理接口返回值的「data」字段"),Ke=l(" 导入（json / txt） "),We=l(" 下载 "),Ye=l("点击【下载】查看完整数据"),et=oe({__name:"index",props:{show:{type:Boolean,required:!1},ajax:{type:Boolean,required:!0}},setup(h){const{targetData:_}=ae(),y=["字段","映射","状态"],{HelpOutlineIcon:A}=L.ionicons5,{DocumentAddIcon:f,DocumentDownloadIcon:v}=L.carbon,a=B(),p=B(),r=B(),F=B(!1),{uploadFileListRef:k,customRequest:O,beforeUpload:R,download:V}=Qe(_),$=J(()=>_.value.request.requestDataType!==Fe.STATIC),q=J(()=>_.value.chartConfig.chartFrame===ee.ECHARTS),m=u=>{let s=U.SUCCESS;for(let d=0;d<a.value.length;d++)if(a.value[d][u]===void 0)return s=U.FAILURE,s;return U.SUCCESS},E=()=>{try{return p.value.map((u,s)=>s===0?{field:"通用标识",mapping:u,result:U.NULL}:{field:`数据项-${s}`,mapping:u,result:m(u)})}catch(u){return[]}};return ne(()=>{var u,s;return(s=(u=_.value)==null?void 0:u.option)==null?void 0:s.dataset},u=>{var s,d;u&&((d=(s=_==null?void 0:_.value)==null?void 0:s.chartConfig)==null?void 0:d.chartFrame)===ee.ECHARTS?(a.value=u,q.value&&(p.value=u.dimensions,r.value=E())):u!=null?(r.value=null,a.value=u):(F.value=!0,a.value="此组件无数据源"),he(u)&&(r.value=null)},{immediate:!0}),(u,s)=>{const d=n("n-badge"),i=n("n-text"),w=n("n-space"),x=n("n-table"),b=n("n-timeline-item"),T=n("n-icon"),j=n("n-button"),H=n("n-upload"),D=n("n-tooltip"),le=n("n-code"),se=n("n-card"),ce=n("n-timeline");return C(),S(ce,{class:"go-chart-configurations-timeline"},{default:e(()=>[K(t(b,{type:"info",title:o(M).MAPPING},{default:e(()=>[t(x,{striped:""},{default:e(()=>[c("thead",null,[c("tr",null,[(C(),N(P,null,Y(y,g=>c("th",{key:g},I(g),1)),64))])]),c("tbody",null,[(C(!0),N(P,null,Y(r.value,(g,re)=>(C(),N("tr",{key:re},[c("td",null,I(g.field),1),c("td",null,I(g.mapping),1),c("td",null,[g.result===0?(C(),S(w,{key:0},{default:e(()=>[t(d,{dot:"",type:"success"}),t(i,null,{default:e(()=>[Xe]),_:1})]),_:1})):(C(),S(w,{key:1},{default:e(()=>[t(d,{dot:"",type:g.result===1?"success":"error"},null,8,["type"]),t(i,null,{default:e(()=>[l("匹配"+I(g.result===1?"成功":"失败"),1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})]),_:1},8,["title"]),[[W,o(q)&&r.value]]),K(t(b,{color:"#97846c",title:o(M).FILTER},{default:e(()=>[t(w,{size:18,vertical:""},{default:e(()=>[t(i,{depth:"3"},{default:e(()=>[Ze]),_:1}),t(o(Ge))]),_:1})]),_:1},8,["title"]),[[W,o($)]]),t(b,{type:"success",title:o(M).CONTENT},{default:e(()=>[t(w,{vertical:""},{default:e(()=>[t(w,{class:"source-btn-box"},{default:e(()=>[t(H,{"file-list":o(k),"onUpdate:file-list":s[0]||(s[0]=g=>ve(k)?k.value=g:null),"show-file-list":!1,customRequest:o(O),onBeforeUpload:o(R)},{default:e(()=>[t(w,null,{default:e(()=>[h.ajax?Ee("",!0):(C(),S(j,{key:0,class:"sourceBtn-item",disabled:F.value},{icon:e(()=>[t(T,null,{default:e(()=>[t(o(f))]),_:1})]),default:e(()=>[Ke]),_:1},8,["disabled"]))]),_:1})]),_:1},8,["file-list","customRequest","onBeforeUpload"]),c("div",null,[t(j,{class:"sourceBtn-item",disabled:F.value,onClick:o(V)},{icon:e(()=>[t(T,null,{default:e(()=>[t(o(v))]),_:1})]),default:e(()=>[We]),_:1},8,["disabled","onClick"]),t(D,{trigger:"hover"},{trigger:e(()=>[t(T,{class:"go-ml-1",size:"21",depth:3},{default:e(()=>[t(o(A))]),_:1})]),default:e(()=>[t(i,{depth:"3"},{default:e(()=>[Ye]),_:1})]),_:1})])]),_:1}),t(se,{size:"small"},{default:e(()=>[t(le,{code:o(z)(a.value),language:"json"},null,8,["code"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})}}}),ft=ue(et,[["__scopeId","data-v-72544ebc"]]);export{ft as C};
