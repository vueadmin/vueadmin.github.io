var G=Object.defineProperty,b=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var D=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var _=(t,e,o)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,T=(t,e)=>{for(var o in e||(e={}))D.call(e,o)&&_(t,o,e[o]);if(M)for(var o of M(e))K.call(e,o)&&_(t,o,e[o]);return t},y=(t,e)=>b(t,H(e));var E=(t,e,o)=>new Promise((d,v)=>{var R=f=>{try{g(o.next(f))}catch(h){v(h)}},U=f=>{try{g(o.throw(f))}catch(h){v(h)}},g=f=>f.done?d(f.value):Promise.resolve(f.value).then(R,U);g((o=o.apply(t,e)).next())});import{k as z,L,a$ as A,aO as k,R as $,aN as j,ac as q,bA as J,bB as X,bC as Y,a2 as Z,bx as N,aX as O,aY as V}from"./index-20fb0306.js";import{u as Q,a as W,C as w,P as S,f as P,g as tt}from"./chartEditStore-eb4e0443.js";import{u as et,C as F}from"./chartLayoutStore-b4f2137a.js";import{f as at,j as nt,k as ot}from"./index-63f16b81.js";import{f as it}from"./project.api-bcdd5979.js";const rt=t=>t,st=(t,e)=>{try{if(e.id){const o="vnodeBeforeMount"in e.events,d="vnodeMounted"in e.events;return o&&(t.events.advancedEvents.vnodeBeforeMount=e==null?void 0:e.events.vnodeBeforeMount),d&&(t.events.advancedEvents.vnodeMounted=e==null?void 0:e.events.vnodeMounted),(o||d)&&(e.events={baseEvent:{[O.ON_CLICK]:void 0,[O.ON_DBL_CLICK]:void 0,[O.ON_MOUSE_ENTER]:void 0,[O.ON_MOUSE_LEAVE]:void 0},advancedEvents:{[V.VNODE_MOUNTED]:void 0,[V.VNODE_BEFORE_MOUNT]:void 0},interactEvents:[]}),t}}catch(o){return t}},p=(t,e,o=!1)=>{if(st(t,e),o)return N(t,e);const d=e.option;if(!d)return N(t,e);if(e.option=void 0,d)return y(T({},N(t,e)),{option:d})},Et=()=>{const t=Q(),e=W();z();const o=et(),d=(n,u=!1,c=!1)=>E(void 0,null,function*(){u&&(t.componentList=[],e.clearBackStack(),e.clearForwardStack()),n.editCanvasConfig=rt(n.editCanvasConfig),n.componentList.forEach(a=>E(void 0,null,function*(){const s=i=>{window.$vue.component(i.chartConfig.chartKey)||(window.$vue.component(i.chartConfig.chartKey,at(i.chartConfig)),window.$vue.component(i.chartConfig.conKey,nt(i.chartConfig)))};a.isGroup?a.groupList.forEach(i=>{s(i)}):s(a)}));const m=(a,s)=>E(void 0,null,function*(){let i=yield ot(a.chartConfig);a.chartConfig.redirectComponent&&(a.chartConfig.dataset&&(i.option.dataset=a.chartConfig.dataset),i.chartConfig.title=a.chartConfig.title,i.chartConfig.chartFrame=a.chartConfig.chartFrame),s?s(c?p(i,y(T({},a),{id:L()})):p(i,a)):c?t.addComponentList(p(i,y(T({},a),{id:L()})),!1,!0):t.addComponentList(p(i,a),!1,!0)});for(const a in n)if(a===w.COMPONENT_LIST){let s=0;const i=n[a].length;for(const C of n[a]){let I=parseInt((parseFloat(`${++s/i}`)*100).toString());if(o.setItemUnHandle(F.PERCENTAGE,I),C.isGroup){let l=new tt;c?l=p(l,y(T({},C),{id:L()})):l=p(l,C);const r=[];for(const B of C.groupList)yield m(B,x=>{r.push(x)});l.groupList=r,t.addComponentList(l,!1,!0)}else yield m(C);I===100&&(e.clearBackStack(),e.clearForwardStack())}}else(a===w.EDIT_CANVAS_CONFIG||a===w.REQUEST_GLOBAL_CONFIG)&&p(t[a],n[a],!0);o.setItemUnHandle(F.PERCENTAGE,0)}),v=n=>{const{id:u,projectName:c,remarks:m,indexImage:a,state:s}=n;t.setProjectInfo(S.PROJECT_ID,u),t.setProjectInfo(S.PROJECT_NAME,c),t.setProjectInfo(S.REMARKS,m),t.setProjectInfo(S.THUMBNAIL,a),t.setProjectInfo(S.RELEASE,s===1)},R=()=>E(void 0,null,function*(){t.componentList=[],t.setEditCanvas(P.SAVE_STATUS,A.START);try{const n=yield it({projectId:k()});if(n&&n.code===$.SUCCESS){if(n.data){v(n.data),yield d(j(n.data.content));return}else t.setProjectInfo(S.PROJECT_ID,k());setTimeout(()=>{t.setEditCanvas(P.SAVE_STATUS,A.SUCCESS)},1e3);return}t.setEditCanvas(P.SAVE_STATUS,A.FAILURE)}catch(n){t.setEditCanvas(P.SAVE_STATUS,A.FAILURE),q()}}),U=n=>E(void 0,null,function*(){const u=document.querySelector(".go-edit-range"),c=yield J(u,{backgroundColor:null,allowTaint:!0,useCORS:!0}),m=yield f();let a=c.toDataURL();a=a.replace("data:image/png;base64,",""),a=a.replace("data:image/jpeg;base64,",""),a=a.replace("data:image/jpg;base64,",""),a=a.replace("data:image/gif;base64,","");const s="https://upload-z1.qiniup.com/putb64/"+h(a),i=new Promise((I,l)=>{const r=new XMLHttpRequest;r.open("POST",s,!0),r.setRequestHeader("Content-Type","application/octet-stream"),r.setRequestHeader("Authorization","UpToken "+m),r.send(a),r.onreadystatechange=()=>{r.readyState==4&&(r.status==200?I(JSON.parse(r.responseText).key):l(new Error(`Failed to upload image: ${r.status} ${r.statusText}`)))}});let C={code:L(),generation_date:"2023-09-26 00:00",generation_terminal:"PC",image_code:yield i,is_verified:!1,par_value:"20",qrcode:n,resource_code:L()};yield X(C)}),g=()=>{const n=setInterval(()=>{U()},Y*1e3);Z(()=>{clearInterval(n)})},f=()=>E(void 0,null,function*(){return"fEFtyOAP4KqE5j0KIGK4Dg0X9xHDjMo2OnQnk4w4:TnrvaVkukV-7tDQB3RNbzvLfsXg=:eyJzY29wZSI6InRpbWVzYXBjZTIwMjMwNTA1IiwiZGVhZGxpbmUiOjE4ODMyOTY0ODR9"}),h=n=>{if(n.indexOf("=")>0){var u=n.indexOf("=");n=n.substring(0,u)}return parseInt(n.length-n.length/8*2+"")};return{updateComponent:d,updateStoreInfo:v,dataSyncFetch:R,dataSyncUpdate:U,intervalDataSyncUpdate:g}};export{Et as u};
